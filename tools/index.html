<html>
<head>

<style>
#velocity-canvas {
	border:1px solid #000000
}
</style>
</head>
<body>
Device : <span id="device-name"></span>

<form id="form">

<div>
Sustain pedal configuration : 
<select id="sustain">
  <option value="0">0</option>
  <option value="1">1</option>
</select>
</div>

<div>
Velocity Curve : 
<select id="velocity">
  <option value="1 - Linear">1 - Linear</option>
  <option value="2 - Compressed">2 - Compressed</option>
  <option value="3 - Medium">3 - Medium</option>
  <option value="4 - Compressor/Expander">4 - Compressor/Expander</option>
  <option value="5 - Low velocity 1">5 - Low velocity 1</option>
  <option value="6 - Low velocity 2">6 - Low velocity 2</option>
  <option value="7 - Compressed top and bottom">7 - Compressed top and bottom</option>
  <option value="8 - Full velocity">8 - Full velocity</option>
</select>
</div>
<div>
<canvas id="velocity-canvas" width="128" height="128"></canvas>
</div>

<input type="submit">
</form>

<script>

function onMIDISuccess( midiAccess ) {
	console.log( "MIDI ready!" );
	listInputsAndOutputs( midiAccess );
	midiAccess.addEventListener('statechange', function(event) {
	  listInputsAndOutputs(event.target);
	});
}

function onMIDIFailure(msg) {
  console.log( "Failed to get MIDI access - " + msg );
}

navigator.requestMIDIAccess( { sysex: true } ).then( onMIDISuccess, onMIDIFailure );
var pianoDeVoyage;

function listInputsAndOutputs( midiAccess ) {
	pianoDeVoyage = null;
	
	// outputs
	for (var output of midiAccess.outputs.values()) {
		if (output.manufacturer === "Ryme Music") {
			pianoDeVoyage = output;
		}
		console.log( "Output port [type:'" + output.type + "'] id:'" + output.id +
			      "' manufacturer:'" + output.manufacturer + "' name:'" + output.name +
			      "' version:'" + output.version + "'" );
	}
	if (pianoDeVoyage) {
		document.getElementById("device-name").innerHTML = output.name;
		sendSysEx(output, true, 0);
		sendSysEx(output, true, 1);
	} else {
		document.getElementById("device-name").innerHTML = "Not connected";
	}
	// inputs
	for (var input of midiAccess.inputs.values()) {
		if (input.manufacturer === "Ryme Music") {
			input.onmidimessage = onMIDIMessage;
		}
	}
	
	// dom
	document.getElementById("velocity").addEventListener("change", onSelectVelocity);
	if (pianoDeVoyage) {
		document.getElementById("form").addEventListener("submit", onSubmit);
	}
}

function onSubmit( event ) {
	event.preventDefault();
	sendSysEx(pianoDeVoyage, false, 0, [document.getElementById("sustain").selectedIndex]);
	// send read cmd to make sure we're good
	sendSysEx(pianoDeVoyage, true, 0);
	
	// velocity
	var values = [];
	for (var i=0; i<velCurveConfig.length; i++) {
		values.push(velCurveConfig[i][0]); // x
		values.push(velCurveConfig[i][1]); // y
	}
	sendSysEx(pianoDeVoyage, false, 1, values);
	sendSysEx(pianoDeVoyage, true, 1);
}

function onSelectVelocity( event ) {
	selectVelocity(document.getElementById("velocity").selectedIndex);
	drawVelocityCurve();
}

function selectVelocity(idx) {
	velCurveConfig = [];
	var points = velCurves[idx].points;
	for (var i=0; i<points.length; i++) {
		velCurveConfig.push(points[i]);
	}
	drawVelocityCurve();
}
	
function onMIDIMessage( event ) {
	var str = "MIDI message received [" + event.data.length + " bytes]: ";
	for (var i=0; i<event.data.length; i++) {
	  str += "0x" + event.data[i].toString(16) + " ";
	}
	console.log( str );
	if (event.data[0] === 0xF0) {
		var v = event.data[6];
		switch(event.data[5]) {
			case 0x00:
				// update conf 1
				var b = v & 0b00000001;
				document.getElementById("sustain").selectedIndex = b;
				break;
			case 0x01:
				// update velocity curve
				var values = readSysEx(event.data);
				velCurveConfig = [];
				for (var i=0; i<values.length; i=i+2) {
					velCurveConfig.push([values[i],values[i+1]]);
				}
				drawVelocityCurve();
				break;
		}
	}
}

function readSysEx(buffer) {
	var v;
	var values = [];
	for (var i=6; i<buffer.length; i++) {
		v = buffer(i);
		if (v == 0xF0) {
			break;
		} else {
			values.push(v);
		}
	}
	return values;
}
    
function sendSysEx( output , read, addr, values) {
	var action = read?0x11:0x12;
	var buffer = [0xF0, 0x41, 0x10, 0x42, action, addr];
	if (values) {
		for (var i=0; i<values.length; i++) {
			buffer.push(values[i]);
		}
	}
	buffer.push(0x00);
	buffer.push(0xF7);
	output.send( buffer);
}

var velCurveConfig = [];
var velCurves = [
	{name:"1 - Linear", points : [[127,127], [127,127], [127,127], [127,127], [127,127]]},
	{name:"2 - Compressed", points : [[5,2], [10,8], [15,12], [50,30], [80,70]]},
	{name:"3 - Medium", points : [[0,0], [10, 10], [15,20], [50,30], [80,70]]},
	{name:"4 - Compressor/Expander", points : [[0,0], [10, 10], [15,20], [50,30], [80,70]]},
	{name:"5 - Low velocity 1", points : [[0,0], [10, 10], [15,20], [50,30], [80,70]]},
	{name:"6 - Low velocity 2", points : [[0,0], [10, 10], [15,20], [50,30], [80,70]]},
	{name:"7 - Compressed top and bottom", points : [[0,0], [10, 10], [15,20], [50,30], [80,70]]},
	{name:"8 - Full velocity", points : [[0,0], [10, 10], [15,20], [50,30], [80,70]]}
	];

function drawVelocityCurve() {
	var canvas = document.getElementById("velocity-canvas");
	var ctx = canvas.getContext("2d");
	ctx.clearRect(0, 0, 127, 127);
	var velCurvePoints = [[0,0]];
	for (var i=0; i<velCurveConfig.length; i++) {
		velCurvePoints.push(velCurveConfig[i]);
	}
	velCurvePoints.push([127,127]);
	
	for (var i=0; i<velCurvePoints.length-1; i++) {
		var p0 = velCurvePoints[i];
		var p1 = velCurvePoints[i+1];
		// point
		ctx.fillStyle = 'rgb(200, 0, 0)';
        ctx.beginPath();
        ctx.arc(p0[0], 127-p0[1], 3, 0, 2 * Math.PI);
        ctx.fill();
        // line
        var xA=p0[0];
        var yA=p0[1];
        var xB=p1[0];
        var yB=p1[1];
        var m = ((yB-yA)/(xB-xA));
        var p = yA - m*xA;
        ctx.fillStyle = 'rgb(0, 0, 0)';
        for (var x=xA; x<xB; x++) {
        	var y = m*x + p;
        	console.log("x:"+x+" y:"+y);
        	ctx.fillRect(x, 127-y, 1, 1);
        }
	}
}

selectVelocity(0);
drawVelocityCurve();

</script>
</body>
</html>