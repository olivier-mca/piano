<html>
<head>
	<title>RYME - Keyboard Configuration</title>
	<meta name="robots" content="noindex">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-873168-3', 'auto');
      ga('send', 'pageview');
    </script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
<style>
#velocity-canvas {
	border:1px solid #000000
}
</style>

</head>
<body>

<div class="container">

<div id="alert" class="alert alert-success alert-dismissible hidden" role="alert">
  <span id="message"></span>
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>

  <div class="row">
    <div class="col">
      	<h2>Status</h2>
		
		<div id="device">
			Device connected : <span id="device-name"></span> <br>
			Firmware version : <span id="firmware"></span><br>
			Note ON : <span id="noteon" style="display: inline-block;width: 20px;">-</span>
			Pedal : <span id="sustainon" style="display: inline-block;width: 20px;">-</span>
		</div>
    </div>
  </div>
  
    <hr>
  <h2>Configuration</h2>
  <form id="form">
  
    <div class="row">
	    <div class="col">
			<b>
			MIDI Channel
			</b>
			<div>
				Current MIDI channel :   
				<select id="channel" disabled>
				  <option value="0">1 (default)</option>
				  <option value="1">2</option>
				  <option value="2">3</option>
				  <option value="3">4</option>
				  <option value="4">5</option>
				  <option value="5">6</option>
				  <option value="6">7</option>
				  <option value="7">8</option>
				  <option value="8">9</option>
				  <option value="9">10</option>
				  <option value="10">11</option>
				  <option value="11">12</option>
				  <option value="12">13</option>
				  <option value="13">14</option>
				  <option value="14">15</option>
				  <option value="15">16</option>
				</select>
			</div>
	    </div>
    </div>
  
  <div class="row">
    <div class="col">
		<b>
		Sustain Pedal
		</b>
		<div>
			ON MIDI value is  
			<select id="sustain" disabled>
			  <option value="0">0</option>
			  <option value="1">127 (default)</option>
			</select>
		</div>
    </div>
  </div>
  
  <div class="section" id="octaves" hidden>

  <div class="row">
    <div class="col">
		<b>
		Octave shift
		</b>
		<div>
			Number of octaves 
			<select id="octave" disabled>
			  <option value="0">-3</option>
			  <option value="1">-2</option>
			  <option value="1">-1</option>
			  <option value="1">0 (default)</option>
			  <option value="1">+1</option>
			  <option value="1">+2</option>
			  <option value="1">+3</option>
			</select>
		</div>
    </div>
  </div>

  <div class="row">
    <div class="col">
		<b>
		Transpose
		</b>
		<div>
			Number of semitones   
			<select id="transpose" disabled>
			  <option value="0">-12</option>
			  <option value="1">-11</option>
			  <option value="2">-10</option>
			  <option value="3">-9</option>
			  <option value="4">-8</option>
			  <option value="5">-7</option>
			  <option value="6">-6</option>
			  <option value="7">-5</option>
			  <option value="8">-4</option>
			  <option value="9">-3</option>
			  <option value="10">-2</option>
			  <option value="11">-1</option>
			  <option value="12">0 (default)</option>
			  <option value="13">+1</option>
			  <option value="14">+2</option>
			  <option value="15">+3</option>
			  <option value="16">+4</option>
			  <option value="17">+5</option>
			  <option value="18">+6</option>
			  <option value="19">+7</option>
			  <option value="20">+8</option>
			  <option value="21">+9</option>
			  <option value="22">+10</option>
			  <option value="23">+11</option>
			  <option value="24">+12</option>
			</select>
		</div>
    </div>
  </div>
  
  </div>
  
  <div class="section" id="controlpanel" hidden>
  <hr>
    <div class="row">
	    <div class="col">
		    <b>
			Knobs
			</b>
		    <div class="row">
		    	<div class="col">
					<div>
						Left  
						<select id="knobmode0" disabled>
						  <option value="0">Unassigned</option>
						  <option value="1">MIDI Control</option>
						  <option value="2">Pitch bend</option>
						  <option value="3">Aftertouch</option>
						</select>
						Control number : 
						<input id="knobcontrol0" type="text" maxlength="2" size="2" disabled>
					</div>
				</div>
    		</div>
    		<div class="row">
		    	<div class="col">
					<div>
						Right 
						<select id="knobmode1" disabled>
						  <option value="0">Unassigned</option>
						  <option value="1">MIDI Control</option>
						  <option value="2">Pitch bend</option>
						  <option value="3">Aftertouch</option>
						</select>
						Control number : 
						<input id="knobcontrol1" type="text" maxlength="2" size="2" disabled>
					</div>
				</div>
    		</div>
    		
	    </div>
    </div>
    
    <div class="row">
	    <div class="col">
		    <b>
			Switches
			</b>
			<div class="row">
		    	<div class="col">
					<div>
						Top left  
						<select id="butmode0" disabled>
						  <option value="0">Unassigned</option>
						  <option value="1">Program shift</option>
						  <option value="2">Octave shift</option>
						  <option value="3">Program select</option>
						</select>
						Control number : 
						<input id="butcontrol0" type="text" maxlength="2" size="2" disabled>	
					</div>
				</div>
    		</div>
    		<div class="row">
		    	<div class="col">
					<div>
						Lower left  
						<select id="butmode1" disabled>
						  <option value="0">Unassigned</option>
						  <option value="1">Program shift</option>
						  <option value="2">Octave shift</option>
						  <option value="3">Program select</option>
						</select>
						Control number : 
						<input id="butcontrol1" type="text" maxlength="2" size="2" disabled>	
					</div>
				</div>
    		</div>
		    <div class="row">
		    	<div class="col">
					<div>
						Top right 
						<select id="butmode2" disabled>
						  <option value="0">Unassigned</option>
						  <option value="1">Program shift</option>
						  <option value="2">Octave shift</option>
						  <option value="3">Program select</option>
						</select>
						Control number : 
						<input id="butcontrol2" type="text" maxlength="2" size="2" disabled>	
					</div>
				</div>
    		</div>
    		<div class="row">
		    	<div class="col">
					<div>
						Lower right 
						<select id="butmode3" disabled>
						  <option value="0">Unassigned</option>
						  <option value="1">Program shift</option>
						  <option value="2">Octave shift</option>
						  <option value="3">Program select</option>
						</select>
						Control number : 
						<input id="butcontrol3" type="text" maxlength="2" size="2" disabled>	
					</div>
				</div>
    		</div>
	    </div>
    </div>
  </div>
  <hr>

	<div class="row">
	    <div class="col">
			<b>
			Keyboard Velocity Curve 
			</b>
			<br>
				Current configuration<br>
				<canvas id="velocity-canvas" width="128" height="128"></canvas>
				<br>
				<div id="velocity">
				Velocity Curve Presets<br>
				  <button type="button" id="vel1">1 - Linear</button><br>
				  <button type="button" id="vel2">2 - Compressed</button><br>
				  <button type="button" id="vel3">3 - Medium (default)</button><br>
				  <button type="button" id="vel4">4 - Compressor/Expander</button><br>
				  <button type="button" id="vel5">5 - Low velocity 1</button><br>
				  <button type="button" id="vel6">6 - Low velocity 2</button><br>
				  <button type="button" id="vel7">7 - Compressed top and bottom</button><br>
				  <button type="button" id="vel8">8 - Full velocity</button>
				</div>
	  	</div>
	</div>

	<div class="row">
	    <hr>
	</div>
  
	<div class="row">
	    <div class="col">
			<input id="update" type="submit" class="btn btn-primary" value="Send to keyboard" disabled>
		</div>
	</div>
</form>

<!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
 

<script>
$(function() {
	
const EEPROM_SUSTAIN = 0;
const EEPROM_VELOCITY = 1;
const EEPROM_MIDI_CHANNEL = 22;
const EEPROM_TRANSPOSE = 23;
const EEPROM_OCTAVE = 24;
const EEPROM_PEDAL_TYPE = 25;
const EEPROM_KNOBMODE0 = 26;
const EEPROM_KNOBCTRL0 = 27;
const EEPROM_KNOBMODE1 = 28;
const EEPROM_KNOBCTRL1 = 29;
const EEPROM_BTNMODE0 = 30;
const EEPROM_BTNCTRL0 = 31;
const EEPROM_BTNMODE1 = 32;
const EEPROM_BTNCTRL1 = 33;
const EEPROM_BTNMODE2 = 34;
const EEPROM_BTNCTRL2 = 35;
const EEPROM_BTNMODE3 = 36;
const EEPROM_BTNCTRL3 = 37;
const EEPROM_SERIAL = 125;
const EEPROM_FIRMWARE = 126;
const MANUFACTURER_MIDI_ID = 0x20;
const NOTE_ON = 0x90;
const NOTE_OFF = 0x80;
const CC = 0xb0;
const SUSTAIN = 0x40;


	
function onMIDISuccess( midiAccess ) {
	console.log( "MIDI ready!" );
	midiAccess.addEventListener('statechange', function(event) {
	  listInputsAndOutputs(midiAccess);
	});
	listInputsAndOutputs( midiAccess );
}

function onMIDIFailure(msg) {
  console.log( "Failed to get MIDI access - " + msg );
  document.getElementById("message").innerHTML = 
	  "Sorry, Web MIDI is not supported by your browser, please use Chrome or install the <a href='https://jazz-soft.net/download/web-midi/'>WebMIDI plugin</a>";
  $('#alert').show();
}

if (navigator.requestMIDIAccess) {
	$('#alert').alert('close');
	navigator.requestMIDIAccess( { sysex: true } ).then( onMIDISuccess, onMIDIFailure );
} else {
	onMIDIFailure("");
}

var pianoDeVoyage;

function listInputsAndOutputs( midiAccess ) {
	pianoDeVoyage = null;
	
	// outputs
	var iter = midiAccess.outputs.values();
    for (var o = iter.next(); !o.done; o = iter.next()) {
    	var output = o.value;
		if ((output.name === "Piano de Voyage") || (output.manufacturer === "Ryme Music")) {
			if (output.connection === "open") {
				// inputs
				var inputs = midiAccess.inputs.values();
    			for (var inp = inputs.next(); !inp.done; inp = inputs.next()) {
    			var input = inp.value;
					if (input.name === "Piano de Voyage") {
						if (input.connection === "open") {
							pianoDeVoyage = output;
							input.onmidimessage = onMIDIMessage;			
							console.log( "Output port [type:'" + output.type + "'] id:'" + output.id +
								      "' manufacturer:'" + output.manufacturer + "' name:'" + output.name +
								      "' version:'" + output.version + "'" );
							document.getElementById("device-name").innerHTML = "<span class='text-success'>"+output.name+"</span>";
							var vel = document.getElementById("velocity");
							var items = vel.querySelectorAll("button");
							items.forEach(function(item) {
								  item.addEventListener("click", onSelectVelocity);
								});
							var form = document.getElementById("form");
							for (var i = 0; i < form.length; i++) {
								form[i].removeAttribute("disabled");
							}
							
							form.addEventListener("submit", onSubmit);
							
							// read config
							sendSysEx(pianoDeVoyage, true, EEPROM_FIRMWARE);
							sendSysEx(pianoDeVoyage, true, EEPROM_FIRMWARE); // don't know why but necessary to send twice
							sendSysEx(pianoDeVoyage, true, EEPROM_SUSTAIN);
							sendSysEx(pianoDeVoyage, true, EEPROM_VELOCITY);
							sendSysEx(pianoDeVoyage, true, EEPROM_MIDI_CHANNEL);
							sendSysEx(pianoDeVoyage, true, EEPROM_TRANSPOSE);
							sendSysEx(pianoDeVoyage, true, EEPROM_OCTAVE);
							sendSysEx(pianoDeVoyage, true, EEPROM_KNOBMODE0);
							sendSysEx(pianoDeVoyage, true, EEPROM_BTNMODE0);
						} else {
							// will trigger a state change event
							input.open();
						}
					}
				}
			} else {
				// will trigger a state change event
				output.open();
			}
		}
	}
	
	if (!pianoDeVoyage) {
		document.getElementById("device-name").innerHTML = "<span class='text-warning'>Please connect a compatible device</span>";
	}
}

function onSubmit( event ) {
	event.preventDefault();
	sendSysEx(pianoDeVoyage, false, EEPROM_SUSTAIN, [document.getElementById("sustain").selectedIndex]);
	// send read cmd to make sure we're good
	sendSysEx(pianoDeVoyage, true, EEPROM_SUSTAIN);
	
	sendSysEx(pianoDeVoyage, false, EEPROM_MIDI_CHANNEL, [document.getElementById("channel").selectedIndex]);
	sendSysEx(pianoDeVoyage, true, EEPROM_MIDI_CHANNEL);
	
	// velocity
	var values = [];
	for (var i=0; i<velCurveConfig.length; i++) {
		values.push(velCurveConfig[i][0]); // x
		values.push(127-velCurveConfig[i][1]); // y
	}
	sendSysEx(pianoDeVoyage, false, EEPROM_VELOCITY, values);
	sendSysEx(pianoDeVoyage, true, EEPROM_VELOCITY);
	
	sendSysEx(pianoDeVoyage, false, EEPROM_TRANSPOSE, [document.getElementById("transpose").selectedIndex]);
	sendSysEx(pianoDeVoyage, true, EEPROM_TRANSPOSE);
	
	sendSysEx(pianoDeVoyage, false, EEPROM_OCTAVE, [document.getElementById("octave").selectedIndex]);
	sendSysEx(pianoDeVoyage, true, EEPROM_OCTAVE);
	
	// knobs
	values = [];
	for (var i=0; i<2; i++) {
		values.push(document.getElementById("knobmode"+i).selectedIndex);
		values.push(parseInt(document.getElementById("knobcontrol"+i).value, 16));
	}
	sendSysEx(pianoDeVoyage, false, EEPROM_KNOBMODE0, values);
	sendSysEx(pianoDeVoyage, true, EEPROM_KNOBMODE0);
	
	// switches
	values = [];
	for (var i=0; i<4; i++) {
		values.push(document.getElementById("butmode"+i).selectedIndex);
		values.push(parseInt(document.getElementById("butcontrol"+i).value, 16));
	}
	sendSysEx(pianoDeVoyage, false, EEPROM_BTNMODE0, values);
	sendSysEx(pianoDeVoyage, true, EEPROM_BTNMODE0);
	
	alert("Keyboard configuration updated");
}

function onSelectVelocity( event ) {
	var id = parseInt(event.target.id.charAt(3));
	selectVelocity(id-1);
	drawVelocityCurve();
}

function selectVelocity(idx) {
	velCurveConfig = [];
	var points = velCurves[idx].points;
	for (var i=0; i<points.length; i++) {
		velCurveConfig.push(points[i]);
	}
	drawVelocityCurve();
}
	
function onMIDIMessage( event ) {
	var str = "MIDI message received at timestamp " + event.timestamp + "[" + event.data.length + " bytes]: ";
	for (var i=0; i<event.data.length; i++) {
	  str += "0x" + event.data[i].toString(16) + " ";
	}
	console.log( str );
	var v = event.data[1];
	switch(event.data[0]) {
		case NOTE_ON:
			document.getElementById("noteon").innerHTML = v;
			break;
		case NOTE_OFF:
			document.getElementById("noteon").innerHTML = "-";
			break;
		case CC:
			if (v == SUSTAIN) {
				document.getElementById("sustainon").innerHTML = event.data[2];
				break;
			}
		case 0xF0:
			v = event.data[6];
			var values = readSysExValues(event.data);
			switch(event.data[5]) {
				case EEPROM_SUSTAIN:
					// update conf 1
					var b = v & 0b00000001;
					document.getElementById("sustain").selectedIndex = b;
					break;
				case EEPROM_MIDI_CHANNEL:
					document.getElementById("channel").selectedIndex = v;
					break;
				case EEPROM_OCTAVE:
					document.getElementById("octave").selectedIndex = v;
					break;
				case EEPROM_TRANSPOSE:
					document.getElementById("transpose").selectedIndex = v;
					break;
				case EEPROM_VELOCITY:
					// update velocity curve
					velCurveConfig = [];
					for (var i=0; i<values.length; i=i+2) {
						velCurveConfig.push([values[i],127-values[i+1]]);
					}
					drawVelocityCurve();
					break;
				case EEPROM_FIRMWARE:
					var f = String.fromCharCode(values[0]);
					var v1 = parseInt(String.fromCharCode(values[1]));
					var v2 = parseInt(String.fromCharCode(values[2]));
					var v3 = parseInt(String.fromCharCode(values[3]));
					var v4 = parseInt(String.fromCharCode(values[4]));
					f += v1 + ".";
					f += v2 + ".";
					f += v3 + ".";
					f += v4;
					document.getElementById("firmware").innerHTML = f;
					var panel = document.getElementById("controlpanel");
					if ((v1 >=2) && (v2>3)) {
						panel.removeAttribute("hidden");
					} else {
						panel.setAttribute("hidden", true);
					}
					var octaves = document.getElementById("octaves");
					if (v1>1) {
						octaves.removeAttribute("hidden");
					} else {
						octaves.setAttribute("hidden", true);
					}
					break;
				case EEPROM_KNOBMODE0:
					if (values.length > 2) {
						var idx = 0;
						for (var i=0; i<values.length/2; i++) {
							idx = i*2;
							var mode = values[idx];
							var cc = values[idx+1];
							document.getElementById("knobmode"+i).selectedIndex = mode;
							document.getElementById("knobcontrol"+i).value = cc.toString(16);
						}
					}
					break;
				case EEPROM_BTNMODE0:
					if (values.length > 2) {
						var idx = 0;
						for (var i=0; i<values.length/2; i++) {
							idx = i*2;
							var mode = values[idx];
							var cc = values[idx+1];
							document.getElementById("butmode"+i).selectedIndex = mode;
							document.getElementById("butcontrol"+i).value = cc.toString(16);
						}
					}
					break;
			}
			break;
	}
}

function readSysExValues(buffer) {
	var v, v2;
	var values = [];
	for (var i=6; i<buffer.length; i++) {
		v = buffer[i];
		v2 = buffer[i+1];
		if (v2 === 0xF7) {
			// END of message
			// verifyChecksum(v);
			break;
		} else {
			values.push(v);
		}
	}
	return values;
}
    
function sendSysEx( output , read, addr, values) {
	var action = read?0x11:0x12;
	var buffer = [0xF0, MANUFACTURER_MIDI_ID, 0x10, 0x42, action, addr];
	if (values) {
		for (var i=0; i<values.length; i++) {
			buffer.push(values[i]);
		}
	} else {
		buffer.push(0x00);
	}
	buffer.push(0x00);
	buffer.push(0xF7);
	output.send( buffer);
}

var velCurveConfig = [];
var velCurves = [
	{name:"1 - Linear", points : [[0,127], [127,0], [127,0], [127,0], [127,0],[127,0], [127,0], [127,0], [127,0], [127,0]]},
	{name:"2 - Compressed", points : [[24, 118], [52, 101], [102, 42], [127,0], [127,0],[127,0], [127,0], [127,0], [127,0], [127,0]]},
	{name:"3 - Medium", points : [[11, 98],[27, 74],[62, 65],[97, 57],[116, 21],[121, 5],[127,0], [127,0], [127,0], [127,0]]},
	{name:"4 - Compressor/Expander", points : [[1, 114],[12, 104],[100, 94],[116, 55],[122, 5], [127,0], [127,0], [127,0], [127,0], [127,0]]},
	{name:"5 - Low velocity 1", points : [[6, 120],[30, 120],[53, 112],[81, 89],[102, 59],[113, 30],[119, 5], [127,0], [127,0], [127,0]]},
	{name:"6 - Low velocity 2", points : [[9, 116],[45, 116],[62, 110],[83, 95],[100, 73],[113, 44],[120, 6], [127,0], [127,0], [127,0]]},
	{name:"7 - Compressed top and bottom", points : [[5, 104],[47, 94],[77, 82],[99, 66],[115, 45],[120, 34],[122, 5], [127,0], [127,0], [127,0]]},
	{name:"8 - Full velocity", points : [[0,0], [127,0], [127,0], [127,0], [127,0], [127,0], [127,0], [127,0], [127,0], [127,0]]}
	];

function drawVelocityCurve() {
	var canvas = document.getElementById("velocity-canvas");
	var ctx = canvas.getContext("2d");
	ctx.clearRect(0, 0, 127, 127);
	var velCurvePoints = [[0,127]];
	for (var i=0; i<velCurveConfig.length; i++) {
		velCurvePoints.push(velCurveConfig[i]);
	}
	velCurvePoints.push([127,0]);
	
	for (var i=0; i<velCurvePoints.length-1; i++) {
		var p0 = velCurvePoints[i];
		var p1 = velCurvePoints[i+1];
		// point
		ctx.fillStyle = 'rgb(200, 0, 0)';
        ctx.beginPath();
        ctx.arc(p0[0], p0[1], 3, 0, 2 * Math.PI);
        ctx.fill();
        // line
        var xA=p0[0];
        var yA=p0[1];
        var xB=p1[0];
        var yB=p1[1];
        ctx.moveTo(xA, yA);
        ctx.lineTo(xB, yB);
        ctx.stroke();
	}
}

/*
selectVelocity(0);
drawVelocityCurve();
*/

});

</script>
<div style="color : lightgrey;">v1.6.3</div>
 </body>
</html>